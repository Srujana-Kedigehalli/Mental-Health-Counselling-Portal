{% extends "layout.html" %}
{% block content %}
<h1 class="mb-4">Find Your Perfect Therapist Match</h1>

<!-- Search Form -->
<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title">Tell Us Your Preferences</h5>
        <form method="post">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">I'm looking for help with...</label>
                    <select class="form-select" name="specialization_id" required>
                        <option value="">-- Select a primary concern --</option>
                        {% for spec in specializations %}
                        <option value="{{ spec.SpecializationID }}">{{ spec.SpecializationName }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Preferred Therapist Gender</label>
                    <select class="form-select" name="therapist_gender">
                        <option value="">No Preference</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Non-binary">Non-binary</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Preferred Language</label>
                    <select class="form-select" name="language">
                        <option value="">English</option>
                        <option value="Hindi">Hindi</option>
                        <option value="Kannada">Kannada</option>
                    </select>
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Find My Match</button>
        </form>
    </div>
</div>

<!-- Search Results -->
{% if form_submitted %}
    <h3 class="mb-3">Here are your best matches:</h3>
    {% for therapist in results %}
    <div class="card mb-3">
        <div class="card-body p-4">
            <div class="row align-items-center">
                <div class="col-md-2 text-center">
                    <img src="{{ url_for('static', filename='uploads/' + therapist.ProfilePicture) if therapist.ProfilePicture else 'https://i.pravatar.cc/150?u=' + therapist.Email }}" class="profile-avatar" alt="Therapist">
                </div>
                <div class="col-md-5">
                    <h4>{{ therapist.FirstName }} {{ therapist.LastName }}</h4>
                    <p class="text-muted mb-2">{{ therapist.Biography }}</p>
                    <p><strong>Specializes in:</strong> {{ therapist.spec_names }}</p>
                </div>
                <div class="col-md-5 border-start ps-4">
                    <h5>Why we matched:</h5>
                    <ul class="list-unstyled">
                    {% for reason in therapist.match_reasons %}
                        <li><span class="text-success">âœ”</span> {{ reason }}</li>
                    {% endfor %}
                    </ul>
                    
                    <!-- THIS IS THE CORRECTED AND FUNCTIONAL BOOKING FORM -->
                    <form action="{{ url_for('book_session', therapist_id=therapist.TherapistID) }}" method="post" class="mt-3">
                        <label class="form-label small">Select a date and time to book:</label>
                        <div class="input-group">
                            <input type="datetime-local" class="form-control" name="appointment_time" required>
                            <button type="submit" class="btn btn-success">Book Session</button>
                        </div>
                    </form>
                    <!-- END OF THE FIX -->

                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info">No therapists were found matching your criteria. Please try a broader search.</div>
    {% endfor %}
{% endif %}
{% endblock %}